<!DOCTYPE html>
<html>
<head>
	<link href="frontend/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
	<script src="frontend/jquery.min.js"></script>
	<style>
		body{
			margin:0;
			overflow:hidden;
			background-color:#eee;
			color:#222222;
		}
		.step{
			display: none;
			margin-left: auto;
			margin-right: auto;
			width: 90%;
			height: 90%
			text-align:center;
			vertical-align: middle;
		}
		.step p, .centered{
			margin: 0;
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			font-size: 24px;
			font-weight:bold;
		}
		.button{
			display: block;
			margin: auto;
			margin-top:24px;
			text-align:center;
		}
		.required{
			border: 5px solid #ff0000 !important;
		}
		.error{
			color: #ee0000;
		}
		#output{
			display:block;
		}
	</style>
</head>
<body>
	<div id="init" class="step">
		<p>
			Azonosító: <input type="text" id="sid" placeholder="" required="required" autocomplete="off"/>
			<input type="hidden" id="type" value="info" />
			<input type="button" class="button" value="Indítás" onclick="fill({'sid': true, 'type': true});"/>
		</p>
	</div>
	<div id="hello" class="step">
		<p>
			Hello ez egy kísérlet.<br />
			- nincs epilepsziád
			<input type="button" class="button" value="Elolvastam és elfogadom az itt leírtakat" onclick="next();"/>
		</p>
	</div>
	<div id="login" class="step">
		<p>
			<input type="text" id="nick" placeholder="név" required="required" autocomplete="off"/>
			<select id="gender" required="required">
				<option value="0" selected="selected">férfi</option>
				<option value="1">nő</option>
			</select>
			<select id="avatar" required="required">
				<option value="0" selected="selected">0 mesh</option>
				<option value="1">1 mesh</option>
				<option value="1">2 mesh</option>
			</select>

			<input type="button" class="button" value="Csatlakozás" onclick="fill({'nick':true, 'avatar':true, 'gender':true});"/>
		</p>
	</div>
	<div id="ready" class="step">
		<p>Vedd fel a headsetet!</p>
	</div>
	<div id="over" class="step">
		<p>
			Vége a játéknak
			<input type="button" class="button" value="Tovább" onclick="next();"/>
		</p>
	</div>
	<div id="other" class="step">
		<p>
			Itt még majd ki kell tölteni dolgokat.
		</p>
	</div>


	<div id="output" class="step">
		<p>Connecting...</p>
	</div>

<script>
$(function() {
	var url = new URLSearchParams(window.location.search)
	var ip = url.has("ip") ? url.get("ip") : "127.0.0.1"
	var port = url.has("port") ? url.get("port") : "42069"
	var skip = url.has("skip") ? parseInt(url.get("skip")) : 0
	var socket = "ws://" + ip + ":" + port + "/"
	var connected = false;
	var error = false;

	var current = -1;
	// var steps = ["init", "hello", "q1", "q2", "login", "ready", "vr"];
	var steps = ["init", "login", "ready", "over", "other"]

	// autoconnect
	var ws = new WebSocket(socket);

	ws.onclose = function(event) {
		console.log(event);
		connected = false;
		if (!error){
			output("Disconnected from server")
		}
		ws = null;
	};
	ws.onerror = function(event) {
        console.error(event);
        error = true;
        if (connected){
			output("Disconnected from <i>" + socket + "</i><br />Attempting to reconnect...")
			window.setTimeout(window.location.reload.bind(window.location), 1000);
        }else{
        	if (!url.has("ip") || !url.has("port")){
        		var page = window.location.pathname.split("/").slice(-1);
        		output("Could not connect to <i>" + socket + "</i><br />Try to set GET parameters for page:<br /><i>" + page + "?ip=...&port=...</i>")
        	}else{
        		output("Could not connect to <i>" + socket + "</i>")
        	}
        }
    };
    ws.onopen = function(event) {
		connected = true;
		var last_sid = localStorage.getItem("sid") || 0;
		$("#sid").attr("placeholder", last_sid);
		next();
    };
    ws.onmessage = function (event) {
		data = JSON.parse(event["data"]);
		if (data["data"]["exit"]){
			next();
		}
		console.log(data)
	}

	window.send = function(data){
		if (ws){
			ping = (+ new Date());
			payload = {
				"type": "info",
				"data": data
			};
			ws.send(JSON.stringify(payload));
		}
	};

    window.restart = function(stop=true){
        if (stop){
            send({"terminate": false});
        }
        window.location.reload();
    };

	window.next = function(){
		if (current !=-1 && skip){
			current += skip;
			skip = 0;
			if (current >= steps.length){
				current = steps.length - 1;
				console.log("Can not skip more than " + steps.length);
			}
		}else{
			if (current < steps.length - 1){
				current += 1;
			}else{
				console.log("Maximum steps reached at " + current);
			}
		}
		$(".step").hide();
		$("#" + steps[current]).show();
		$("input[type='button']").prop("disabled", false);
	};

	window.output = function(data){
		$(".step").hide();
		$("#output").html("<p>" + data + "</p>").show();
	};

	window.fill = function(forms){
		// check if all required forms are filled first
		var missing = 0;
		var payload = {};
		for (var key in forms){
			var test = $("#" + key);
			if (test.length){
				if (test.prop("required")){
					if (!test.val() || ! test.val().length){
						test.addClass("required");
						missing += 1;
					}else if (key == "sid"){
						localStorage.setItem("sid", test.val());
					}
				}
				if (forms[key]){
					payload[key] = test.val();
				}else{
					obj = {};				// because
					obj[key] = test.val();	// javascript
					payload[key] = obj;
				}
			}
		}
		if (!missing){
			for (var key in forms){
				$("#" + key).removeClass("required").prop("disabled", true);
			}
			$("input[type='button']").prop("disabled", true);
			send(payload);
			next();
		}
	};

	window.onkeydown = evt => {
		switch (evt.keyCode) {
			// Enter is 13
			// F2
        	case 113:
        		if (current > 0){
					next();
				}
				break;
		}
	};
});

</script>
</body>
</html>