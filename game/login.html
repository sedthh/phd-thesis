<!DOCTYPE html>
<html>
<head>
	<link href="frontend/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
	<script src="frontend/jquery.min.js"></script>
	<style>
		body{
			margin:0;
			overflow:hidden;
			background-color:#eee;
			color:#222222;
		}
		.step{
			display: none;
			margin-left: auto;
			margin-right: auto;
			width: 90%;
			height: 90%;
			text-align:justify;
			padding:12px;
		}
		.centered{
			margin: 0;
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			font-size: 24px;
			font-weight:bold;
			text-align:center;
			vertical-align: middle;
		}
		.button{
			display: block;
			margin: auto;
			margin-top:24px;
			text-align:center;
			padding:12px;
			cursor:pointer;
			color:#000;
		}
		.required{
			border: 5px solid #ff0000 !important;
			display: inline;
		}
		.error{
			color: #ee0000;
		}
		#output{
			display:block;
		}
	</style>
</head>
<body>
	<div id="init" class="step">
		<p class="centered">
			Egyedi azonosító: <input type="text" id="sid" placeholder="" required="required" autocomplete="off"/>
			<input type="hidden" id="type" value="info" />
			<input type="button" class="button" value="Indítás" onclick="fill({'sid': true, 'type': true});"/>
		</p>
	</div>
	<div id="hello_safety" class="step">
		<h3>Köszönjük, hogy részt veszel játékelméleti kutatásunkban!</h3>
		<p>
			A kutatás során Virtuális Valóságban fogsz más játékosokkal együtt játszani, több környi, rövid fogolydilemma játékot.
		</p>
		<p>
			Kérünk alaposan olvasd el az alábbi egészségügyi útmutatót:
			<ul>
				<li>Csak akkor vehetsz részt a kutatásban, ha <b>nem szenvedsz epilepsziás betegségben</b>. A Virtuális Valóságban felvillanó fények és gyors vizuális ingerek bizonyos személyeknél epilepsziás rohamot okozhatnak.</li>
				<li>Csak akkor vehetsz részt a kutatásban, ha <b>nem vagy várandós és nincs semmilyen szívproblémád</b>. Ezt az egészésügyi megkötést több videójáték is alkalmazza.</li>
			</ul>
		</p>
		<p>
			A Virtuális Valóság szemüvegek <b>hosszabb</b> használata sokaknál enyhe szédülést, ritkán hányingert is kiválthat. Ennek oka, hogy belső fülünk más fajta mozgást érzékel, mint amit látunk, hasonlóan a mozgó járművekben érzett rosszulléttől. Ezek a problémák a szemüvegek gyakori használatával, szoktatással enyhülnek, és a felhasználó idővel jóval hosszabb periódusokra is képes lesz viselni a szemüveget.<br />
			Körülbelül 10-15 percig leszel csak Virtuális Valóságban.<br />
			<b>Amennyiben mégis rosszul érzed magad, vagy bármilyen problémád van, jelezd felénk, a kisérlet akármikor megszakítható.</b>
		</p>
		<p>
			A kutatás során létrejövő adataidat (beleértve az általad megadott és a játék során megtett mozgásokat, kiválassztott interakciókat) menteni fogjuk.
			A mentett adatokata kutatás eredményeivel együtt anonimizáltan (neved és elérhetőséged nélkül), publikusan felhasználhatóvá fogjuk tenni. A folytatással beleegyezel, hogy 
			a kísérlet során generálódott adataidat kutatási célokra felhasználhatjuk és mások számára elérhetővé tehetjük. 
		</p>
		<input type="button" class="button" value="Elfogadom a leírtakat és nincs olyan egészségügyi problémám, ami gátolna a részvételben." onclick="next();"/>
	</div>
	<div id="hello_game" class="step">
		<h3>Az online multiplayer játék menete:</h3>
		<ul>
			<li>Virtuális Valóságban fogsz más emberekkel találkozni, akikkel különböző játék helyszineken fogsz rövid ideig játszani, végig ülve. </li>
			<li>A Virtuális Valóságban mindenki egy avatarként fog megjelenni és csak a fejmozgásukat fogod látni. Ebből kell következtetned a döntéseikre! </li>
			<li>Hasonlóan, ők is csak a fejmozgásodat és avatarodat fogják látni. </li>
			<li>A játékok egyszerű, több körös fogolydilemma (Prisoner's Dilemma) játékok lesznek, ahol választanod kell, hogy **együttműködsz**-e a másikkal vagy **kihasználhatod** őt. </li>
			<li>A játékosok véletlenszerűen lesznek összesorsolva (az épp aktívak közül), így előfordulhat, hogy ugyanazzal a személlyel többször is játszani fogsz. </li>
			<li>A feladatod, hogy **minél több** pontot érj el **összesítve** a körök végére. </li>
			<li>A legtöbb pontot elért 3 játékost különdíjban részesítjük. </li>	
		</ul>
		<p>
			Összefoglalva: a rövid online játékok során, pusztán a többi játékos fejmozgására hagyatkozva kell kiismerned őket és minél több pontot szerezned.
		</p>
		<h3>A fogolydilemma leírása:</h3>
		<p>
			# TODO	
		</p>
		<input type="button" class="button" value="Elolvastam és megértettem a játékszabályokat." onclick="next();"/>
	</div>
	<div id="q_demo" class="step">
		<h3>Alapvető információid megadása:</h3>

		Nemed:
		<select id="form_gender" required="required">
			<option value="0" selected="selected">férfi</option>
			<option value="1">nő</option>
			<option value="-1">egyéb / nem válaszol</option>
		</select>
		<br />

		Korod:
		<input type="text" id="form_age" placeholder="" required="required" autocomplete="off"/>
		<br />

		Milyen kezes vagy?
		<select id="form_hand" required="required">
			<option value="0">mindig bal</option>
			<option value="1">általában bal</option>
			<option value="2">nincs preferencia</option>
			<option value="3">általában jobb</option>
			<option value="4" selected="selected">mindig jobb</option>
		</select>
		<br />

		Hordasz-e szemüveget, vagy kontaktlencsét?
		<select id="form_glasses">
			<option value="0" selected="selected">nem</option>
			<option value="1">igen, de csak munkához, olvasáshoz, stb.</option>
			<option value="2">igen, a mindennapokhoz</option>
		</select>
		<br />

		Szenvedsz-e színtévesztésben, színvakságban?
		<select id="form_colorblind">
			<option value="0" selected="selected">nem</option>
			<option value="1">piros / zöld</option>
			<option value="2">kék / srága</option>
			<option value="3">monokromázia</option>
			<option value="4">egyéb</option>
		</select>

		<input type="button" class="button" value="Tovább" onclick="fill({'form_gender':true, 'form_age':true, 'form_hand':true, 'form_glasses':true, 'form_colorblind':true});"/>
	</div>
	<div id="q_game" class="step">
		<h3>Játékokkal kapcsolatos kérdések:</h3>

		Tudod-e mi az a fogolydilemma?
		<select id="form_prisoners" required="required">
			<option value="0" selected="selected">nem hallottam még róla</option>
			<option value="1">már hallottam róla, de nem tudnám elmagyarázni</option>
			<option value="2">ismerem és el is tudnám magyarázni</option>
			<option value="3">nagyon jól ismerem, foglalkoztam a fogalommal</option>
		</select>
		<br />
		Milyen gyakran játszol videójátékokkal?
		<select id="form_videogames" required="required">
			<option value="0" selected="selected">soha nem játszom</option>
			<option value="1">havonta, vagy ritkábban</option>
			<option value="2">havonta több alkalommal</option>
			<option value="3">hetente több alkalommal</option>
			<option value="4">majdnem minden nap</option>
		</select>
		<br />
		Milyen gyakran játszol online, multiplayer videójátékkokal?
		<select id="form_videogames_online" required="required">
			<option value="0" selected="selected">soha nem játszom</option>
			<option value="1">havonta, vagy ritkábban</option>
			<option value="2">havonta több alkalommal</option>
			<option value="3">hetente több alkalommal</option>
			<option value="4">majdnem minden nap</option>
		</select>
		<br />
		Kedvenc videójátékaid:
		<input type="text" id="form_videogames_favorite" placeholder="" autocomplete="off"/>
		<br />

		# TODO: illusztrációk

		Próbáltál-e már egyszerű, 3DOF, okostelefonnal működő (pl: Cardboard, Samsung Gear) virtuális valóság sisakot?
		<select id="form_vr_3dof" required="required">
			<option value="0" selected="selected">nem</option>
			<option value="1">igen próbáltam már ilyen eszközt</option>
			<option value="2">igen van is otthon ilyen eszközöm</option>
			<option value="-1">nem tudom</option>
		</select>
		<br />
		Próbáltál-e már különálló, 6DOF (pl: Oculus, Vive, PSVR, stb.) sisakot?
		<select id="form_vr_6dof" required="required">
			<option value="0" selected="selected">nem</option>
			<option value="1">igen próbáltam már ilyen eszközt</option>
			<option value="2">igen van is otthon ilyen eszközöm</option>
			<option value="-1">nem tudom</option>
		</select>
		<br />
		Ha válaszod alapján bármilyen sisak elérhető számodra otthon vagy a munkahelyeden, iskoládban, akkor kérlek sorold fel itt őket:
		<input type="text" id="form_vr_available" placeholder="" autocomplete="off"/>

		<br />
		<input type="button" class="button" value="Tovább" onclick="fill({'form_videogames':true, 'form_videogames_online':true, 'form_videogames_favorite': true, 'form_vr_3dof':true, 'form_vr_6dof':true, 'form_vr_available':true});"/>
	</div>
	<div id="login" class="step">
		<h3>Saját játékos létrehozása:</h3>

		Becenév (látszani fog a másik játékos számára):
		<input type="text" id="nick" placeholder="" required="required" autocomplete="off"/>
		<br />
		Avatar neme:
		<select id="gender" required="required">
			<option value="0" selected="selected">férfi</option>
			<option value="1">nő</option>
		</select>
		<br />
		Avatár kiválasztása:
		<select id="avatar" required="required">
			<option value="0" selected="selected">0 mesh</option>
			<option value="1">1 mesh</option>
			<option value="1">2 mesh</option>
		</select>

		<br />
		<input type="button" class="button" value="Csatlakozás" onclick="fill({'nick':true, 'avatar':true, 'gender':true});"/>
	</div>
	<div id="ready" class="step">
		<p class="centered">
			Kezdődhet a játék! Vedd fel a headsetet!
		</p>
	</div>
	<div id="over" class="step">
		<p class="centered">
			A játék sikeresen befejeződött. Már csak néhány válaszra van szükségünk tőled a befejezéshez!
			<input type="button" class="button" value="Tovább" onclick="next();"/>
		</p>
	</div>
	<div id="q_exp" class="step">
		Melyik pálya tetszett a legjobban?
		<select id="form_environment_best" required="required">
			<option value="-1" selected="selected">Nincs válasz</option>
		</select>

		Melyik pálya tetszett a legkevésbé?
		<select id="form_environment_worst" required="required">
			<option value="-1" selected="selected">Nincs válasz</option>
		</select>

		Melyik játékos volt a legszimpatikusabb?
		<select id="form_opponent_best" required="required">
			<option value="-1" selected="selected">Nincs válasz</option>
		</select>

		Melyik játékos volt a legkevésbé szimpatikus?
		<select id="form_opponent_worst" required="required">
			<option value="-1" selected="selected">Nincs válasz</option>
		</select>

		Találkoznál-e élőben is valamelyik játékossal?
		<select id="form_opponent_meet" required="required">
			<option value="-1" selected="selected">Nincs válasz</option>
			<option value="0">Senkivel sem szeretnék találkozni</option>
			<option value="1">A legszimpatikusabb játékossal találkoznék</option>
			<option value="2">Több, szimpatikus játékossal is találkoznék</option>
			<option value="3">A legkevésbé szimpatikusokat kivéve mindenkivel találkoznék</option>
			<option value="4">Mindenkivel szívesen találkoznék</option>
		</select>

		Dolgoznál-e együtt élőben is valamelyik játékossal?
		<select id="form_opponent_work" required="required">
			<option value="-1" selected="selected">Nincs válasz</option>
			<option value="0">Senkivel sem szeretnék együtt dolgozni</option>
			<option value="1">A legszimpatikusabb játékossal dolgoznék együtt</option>
			<option value="2">Több, szimpatikus játékossal is dolgoznék együtt</option>
			<option value="3">A legkevésbé szimpatikusokat kivéve mindenkivel dolgoznék együtt</option>
			<option value="4">Mindenkivel szívesen dolgoznék együtt</option>
		</select>

		<input type="button" class="button" value="Csatlakozás" onclick="fill({'form_environment_best':true, 'form_environment_worst':true, 'form_opponent_best':true, 'form_opponent_worst':true, 'form_opponent_meet':true, 'form_opponent_work':true});"/>
	</div>
	<div id="explanation" class="step">
		<h3>A kísérlet valódi célja:</h3>
		A játék folyamán nem valódi emberekkel játszottál. Az ellenfeleid csupán számítógépes játékosok voltak.
		<br />
		Minden pályát, ellenfelet és azok stratégiáit véletlenszerűen kaptad. 
		<br />
		A kutatás lényege az volt, hogy megmérjük, miként hat a környezet és a másik avatarja a viselkedésünkre.
		
		Mivel minden, amivel találkoztál véletlenszerű volt, elegendő résztvevő segítségével eldönthető, hogy mely környezetek és avatarok ösztönzik az embereket inkább együttműködésre. 
		<br />
		<input type="button" class="button" value="Elolvastam" onclick="next();"/>
	</div>
	<div id="q_reveal" class="step">
		Feltünt, hogy nem valódi játékosokkal játszottál?
		<select id="form_reveal_knew" required="required">
			<option value="-1" selected="selected">Nincs válasz</option>
			<option value="0">Nem tudtam</option>
			<option value="1">Kicsit sejtettem</option>
			<option value="2">Majdnem biztos voltam benne</option>
			<option value="3">Végig tudtam</option>
		</select>

		Tetszett a kísérlet?
		<select id="form_reveal_like" required="required">
			<option value="-1" selected="selected">Nincs válasz</option>
			<option value="0">Egyáltalán nem tetszett - 1</option>
			<option value="1">Alig élveztem - 2</option>
			<option value="2">Közömbös - 3</option>
			<option value="3">Tetszett - 4</option>
			<option value="4">Nagyon tetszett - 5</option>
		</select>

		Hozzáfűzni való a kísérlethez:
		<input type="text" id="form_reveal_extra" placeholder="" autocomplete="off"/>
		<br />

		<hr />
		Szeretnéd, hogy elküldjük az eredményeket e-mailben?
		<select id="form_reveal_email" required="required">
			<option value="0">Nem szeretném</option>
			<option value="1" selected="selected">Igen, kérem</option>
		</select>

		<input type="button" class="button" value="Befejezés" onclick="fill({'form_reveal_knew':true, 'form_reveal_like':true, 'form_reveal_extra':true, 'form_reveal_email':true});"/>
	</div>
	<div id="bye" class="step">
		<h3 class="centered">Köszönjük, hogy segítettél a kutatásban!</h3>
	</div>

	<div id="output" class="step">
		<p class="centered">
			Kapcsolódás...
		</p>
	</div>

<script>
$(function() {
	var url = new URLSearchParams(window.location.search)
	var ip = url.has("ip") ? url.get("ip") : "127.0.0.1"
	var port = url.has("port") ? url.get("port") : "42069"
	var skip = url.has("skip") ? parseInt(url.get("skip")) : 0
	var quick = url.has("quick")
	var socket = "ws://" + ip + ":" + port + "/"
	var connected = false;
	var error = false;

	var current = -1;
	var history = [];
	if (quick){
		// for game testing, ignore logging user data
		 var steps = ["init", "login", "ready", "over"];
	}else{
		// running experiment
		var steps = ["init", "hello_safety", "hello_game", "q_demo", "q_game", "login", "ready", "over", "q_exp", "explanation", "q_reveal", "bye"]
	}

	// autoconnect
	var ws = new WebSocket(socket);

	ws.onclose = function(event) {
		console.log(event);
		connected = false;
		if (!error){
			output("Disconnected from server")
		}
		ws = null;
	};
	ws.onerror = function(event) {
        console.error(event);
        error = true;
        if (connected){
			output("Disconnected from <i>" + socket + "</i><br />Attempting to reconnect...")
			window.setTimeout(window.location.reload.bind(window.location), 1000);
        }else{
        	if (!url.has("ip") || !url.has("port")){
        		var page = window.location.pathname.split("/").slice(-1);
        		output("Could not connect to <i>" + socket + "</i><br />Try to set GET parameters for page:<br /><i>" + page + "?ip=...&port=...</i>")
        	}else{
        		output("Could not connect to <i>" + socket + "</i>")
        	}
        }
    };
    ws.onopen = function(event) {
		connected = true;
		var last_sid = localStorage.getItem("sid") || 0;
		$("#sid").attr("placeholder", last_sid);
		next();
    };
    ws.onmessage = function (event) {
		data = JSON.parse(event["data"]);
		// if the game is over, show next page
		if ("exit" in data["data"] && data["data"]["exit"]){
			next();
		}
		if ("history" in data["data"]){
			h = data["data"]["history"];
			stages = '<option value="-1" selected="selected">Nincs válasz</option>'
			avatars = '<option value="-1" selected="selected">Nincs válasz</option>'
			names = '<option value="-1" selected="selected">Nincs válasz</option>'
			for (var i=0; i<h.length; i++){
				stages += '<option value="'+i+'">'+h[i]["stage"]+'</option>'
				avatars += '<option value="'+i+'">'+h[i]["avatar"]+'</option>'
				// TODO: name
			}
			$("#form_environment_best").html(stages)
			$("#form_environment_worst").html(stages)
			$("#form_opponent_best").html(avatars)
			$("#form_opponent_worst").html(avatars)
		}
		// console.log(data);
	};

	window.send = function(data){
		if (ws){
			ping = (+ new Date());
			payload = {
				"type": "info",
				"data": data
			};
			ws.send(JSON.stringify(payload));
		}
	};

    window.restart = function(stop=true){
        if (stop){
            send({"terminate": false});
        }
        window.location.reload();
    };

	window.next = function(){
		if (current !=-1 && skip){
			current += skip;
			skip = 0;
			if (current >= steps.length){
				current = steps.length - 1;
				console.log("Can not skip more than " + steps.length);
			}
		}else{
			if (current < steps.length - 1){
				current += 1;
			}else{
				console.log("Maximum steps reached at " + current);
			}
		}
		if (current > 0){
			localStorage.setItem("checkpoint", current)
		}
		display();
	};

	window.display = function(loadCheckpoint=false){
		if (loadCheckpoint){
			current = parseInt(localStorage.getItem("checkpoint"))  || -1;
		}
		$(".step").hide();
		$("#" + steps[current]).show();
		$("input[type='button']").prop("disabled", false);
	}

	window.output = function(data){
		$(".step").hide();
		$("#output").html('<p class="centered">' + data + '</p>').show();
	};

	window.fill = function(forms){
		// check if all required forms are filled first
		var missing = 0;
		var payload = {};
		for (var key in forms){
			var test = $("#" + key);
			if (test.length){
				if (test.prop("required")){
					if (!test.val() || !test.val().length){
						test.addClass("required");
						test.focus();
						missing += 1;
					}else if (key == "sid"){
						localStorage.setItem("sid", test.val());
					}
				}
				if (forms[key]){
					payload[key] = test.val();
				}else{
					obj = {};				// because
					obj[key] = test.val();	// javascript
					payload[key] = obj;
				}
			}
		}
		if (!missing){
			for (var key in forms){
				$("#" + key).removeClass("required").prop("disabled", true);
			}
			$("input[type='button']").prop("disabled", true);
			send(payload);
			next();
		}
	};

	window.onkeydown = evt => {
		switch (evt.keyCode) {
			// Enter
			case 13:
				if (!$("#" + steps[current] + " input:focus, #" + steps[current] + " select:focus").length){
					// focus on first form element if nothing has focus
					$("#" + steps[current] + " input:not([type=hidden]), #" + steps[current] + " select").first().focus();
				}else{
					if ($("#" + steps[current] + " .required").length){
						// focus on required form that is empty
						if (!$("#" + steps[current] + " input[required]:focus, #" + steps[current] + " select[required]:focus").length){
							$("#" + steps[current] + " .required").first().focus()
						}else{	
							test = $("#" + steps[current] + " input[required], #" + steps[current] + " select[required]");
							empty = false;
							for (var i=0; i<test.length; i++){
								if (!$(test[i]).val()){
									$(test[i]).focus();
									empty = true;	
									break;
								}
							}
							// required form elements are now filled, focus on button
							if (!empty){
								$("#" + steps[current] + " input[type='button']").first().focus();
							}
						}
					}else{
						// focus on next form that isn't hidden
						$("#" + steps[current] + " input:focus, #" + steps[current] + " select:focus").nextAll("input:not([type=hidden]), select").first().focus();
					}

				}
				if ($("#" + steps[current] + " input[type='button']").first().is(':focus')){
					// click focused button on keypress
					$("#" + steps[current] + " input[type='button']").first().click().blur();
				}
			
				break;
			// F2 skip to last checkpoint if any
        	case 113:
        		display(true);
				break;
			// F4 skip game (only works at parts whene the game should be running)
				case 115:
        			if (current > 0 && (steps[current] == "ready" || steps[current] == "over")){
						next();
					}
				break;
		}
	};
});

</script>
</body>
</html>